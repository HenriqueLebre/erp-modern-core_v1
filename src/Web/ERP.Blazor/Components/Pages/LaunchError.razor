@page "/launch-error"
@layout AuthLayout
@using Microsoft.AspNetCore.WebUtilities
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>ModernERP - Erro ao Iniciar</PageTitle>

<div class="auth-card">
    <div class="status-icon status-icon-error">
        ‚úï
    </div>
    
    <h2 class="status-title">N√£o foi poss√≠vel iniciar o ERP</h2>
    <p class="status-description">
        O protocolo <code>sysfood://</code> n√£o est√° registrado no sistema
    </p>

    <div class="steps-card">
        <h4 class="steps-card-title">
            <span>üîß</span>
            O que fazer?
        </h4>
        <ol class="steps-list">
            <li>Baixe e instale o SysfoodLauncher</li>
            <li>Execute o instalador como Administrador</li>
            <li>Reinicie o navegador</li>
            <li>Tente fazer login novamente</li>
        </ol>
    </div>

    <div class="copy-command">
        <p class="copy-command-label">Ou inicie manualmente</p>
        <div class="copy-command-box">
            <input type="text" 
                   class="copy-command-input" 
                   value="@launchCommand" 
                   readonly />
            <button class="copy-command-btn" @onclick="CopyToClipboard">
                @if (copied)
                {
                    <span>‚úì</span>
                    <span>Copiado</span>
                }
                else
                {
                    <span>üìã</span>
                    <span>Copiar</span>
                }
            </button>
        </div>
        @if (copied)
        {
            <p class="copy-feedback">
                <span>‚úì</span> Comando copiado para a √°rea de transfer√™ncia
            </p>
        }
    </div>

    <div class="action-buttons center">
        <a href="/login" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m12 19-7-7 7-7"></path>
                <path d="M19 12H5"></path>
            </svg>
            Voltar ao Login
        </a>
        <button class="btn btn-secondary" @onclick="RetryLaunch">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
            </svg>
            Tentar Novamente
        </button>
    </div>

    <div class="helpful-links">
        <p class="helpful-links-title">Links √öteis</p>
        <div class="helpful-links-list">
            <a href="#" class="btn btn-sm btn-ghost">
                üì• Baixar Launcher
            </a>
            <a href="#" class="btn btn-sm btn-ghost">
                ‚ùì Central de Ajuda
            </a>
        </div>
    </div>
</div>

@code {
    private string token = string.Empty;
    private string username = string.Empty;
    private string launchCommand = string.Empty;
    private bool copied = false;

    protected override void OnInitialized()
    {
        var uri = new Uri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("token", out var tokenValue))
            token = tokenValue.ToString();

        if (query.TryGetValue("user", out var userValue))
            username = userValue.ToString();

        launchCommand = $"sysfood://launch?token={Uri.EscapeDataString(token)}&user={Uri.EscapeDataString(username)}";
    }

    private async Task CopyToClipboard()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", launchCommand);
            copied = true;
            StateHasChanged();
            
            await Task.Delay(3000);
            copied = false;
            StateHasChanged();
        }
        catch
        {
            // Fallback se clipboard API n√£o estiver dispon√≠vel
        }
    }

    private async Task RetryLaunch()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("open", launchCommand, "_self");
            await Task.Delay(1000);
            NavigationManager.NavigateTo("/launch-success");
        }
        catch
        {
            // Se ainda falhar, permanecer na p√°gina de erro
        }
    }
}
